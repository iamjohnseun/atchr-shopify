{%- comment -%}
Atchr Chat Widget - Theme Block
{%- endcomment -%}

{%- liquid
  assign entity_id = block.settings.entity_id
  if entity_id == blank
    assign entity_id = app.metafields.atchr.entity_id
    if entity_id == blank and request.design_mode
      assign entity_id = 'Example: 12345678-90ab-cdef-ghij-klmnopqrstuv'
    endif
  endif
-%}

<div 
  id="atchr-widget-container-{{ block.id }}" 
  class="atchr-widget-container"
  {{ block.shopify_attributes }}>
</div>

<script>
  (function() {
    // Handle Atchr Dashboard links - open in new tab
    document.addEventListener('DOMContentLoaded', function() {
      var atchrLinks = document.querySelectorAll('a[href*="atchr.com"]');
      atchrLinks.forEach(function(link) {
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');
      });
    });
    
    if (window.Shopify && window.Shopify.designMode) {
      document.addEventListener('shopify:block:select', function(event) {
        const block = event.target;
        const entityId = block.dataset.entityId;
        const input = block.querySelector('[id*="entity_id"]');
        if (input && entityId) {
          input.placeholder = entityId;
        }
      });
    }
    
    var entityId = {{ entity_id | json }};
    var isEmbed = {% if block.target == 'body' %}true{% else %}false{% endif %};

    var containerId = 'atchr-widget-container-{{ block.id }}';
    var container = document.getElementById(containerId);
    
    if (!entityId) {
      container.innerHTML = '<div style="padding: 20px; background: #f8f8f8; border: 1px dashed #ccc; text-align: center; color: #666; font-family: -apple-system, BlinkMacSystemFont, sans-serif; border-radius: 4px;"><p style="margin: 0 0 8px 0;"><strong>Atchr Chat Widget</strong></p><p style="margin: 0; font-size: 14px;">Please configure your Entity ID in the Atchr Messaging settings.</p></div>';
      return;
    }
    
    var script = document.createElement("script");
    script.async = true;
    script.src = "https://embed.atchr.com/" + entityId;
    script.charset = "UTF-8";
    script.setAttribute("crossorigin", "*");
    script.setAttribute("scrolling", "no");
    script.setAttribute("allowTransparency", "true");
    
    script.onerror = function() {
      container.innerHTML = '<div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; text-align: center; color: #856404; font-family: -apple-system, BlinkMacSystemFont, sans-serif; border-radius: 4px;"><p style="margin: 0;">Failed to load Atchr Widget</br>Please review your Entity ID.</p></div>';
    };
    
    var firstScript = document.getElementsByTagName("script")[0];
    firstScript.parentNode.insertBefore(script, firstScript);
  })();
</script>

{% schema %}
{
  "name": "Atchr Chat Widget",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "Widget Settings"
    },
    {
      "type": "text",
      "id": "entity_id",
      "label": "Entity ID",
      "info": "Override this widget's Entity ID. Leave blank to use the default ID in your Atchr settings.",
      "placeholder": "e.g. 12345678-90ab-cdef-ghij"
    },
    {
      "type": "header",
      "content": "Styling & Positioning"
    },
    {
      "type": "paragraph",
      "content": "Widget appearance, colors, and positioning can be changed on your [Atchr Dashboard](https://atchr.com/redirect)."
    }
  ]
}
{% endschema %}